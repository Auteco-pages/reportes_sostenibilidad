import{a as Q}from"./chunk-2PSR7T7J.js";import{a as R,b as g,c as k,d as O,e as V,f as U,g as $,i as L,j,k as q,l as H,q as Y,r as z,s as J,t as K}from"./chunk-6S4UDF73.js";import{B as s,C as f,F as D,G as u,I as m,K as i,L as r,M as p,P as F,Q as h,R as c,S as a,T as I,U as v,W as y,Y as N,Z as T,a as C,b,c as _,da as A,ea as P,fa as w,ga as B,ha as G,na as M,s as x,w as S,x as E}from"./chunk-ACHKL7EZ.js";function Z(n,d){if(n&1&&(i(0,"span",32),a(1),r()),n&2){let e=c().$implicit,t=c();s(),v(" ",t.getErrorMessage(e,"nombre_programa")," ")}}function ee(n,d){if(n&1&&(i(0,"span",32),a(1),r()),n&2){let e=c().$implicit,t=c();s(),v(" ",t.getErrorMessage(e,"cantidad_beneficiados")," ")}}function te(n,d){if(n&1&&(i(0,"span",32),a(1),r()),n&2){let e=c().$implicit,t=c();s(),v(" ",t.getErrorMessage(e,"monto_invertido")," ")}}function oe(n,d){if(n&1){let e=F();i(0,"button",33),h("click",function(){S(e);let o=c().index,l=c();return E(l.eliminarFilaPrograma(o))}),a(1," \u274C "),r()}}function ie(n,d){if(n&1&&(i(0,"tr",25)(1,"td"),p(2,"input",26),u(3,Z,2,1,"span",27),r(),i(4,"td"),p(5,"input",28),u(6,ee,2,1,"span",27),r(),i(7,"td"),p(8,"input",29),u(9,te,2,1,"span",27),r(),i(10,"td",30),u(11,oe,2,0,"button",31),r()()),n&2){let e=d.$implicit,t=d.index,o=c();m("formGroupName",t),s(2),m("ngClass",o.getFieldClass(e,"nombre_programa")),s(),m("ngIf",o.shouldShowError(e,"nombre_programa")),s(2),m("ngClass",o.getFieldClass(e,"cantidad_beneficiados")),s(),m("ngIf",o.shouldShowError(e,"cantidad_beneficiados")),s(2),m("ngClass",o.getFieldClass(e,"monto_invertido")),s(),m("ngIf",o.shouldShowError(e,"monto_invertido")),s(2),m("ngIf",o.programas.length>1)}}var pe=(()=>{class n extends J{constructor(e,t,o,l){super(),this.formBuilder=e,this.formService=t,this.formDataService=o,this.router=l,this.desarrolloComunitario=!0,this.datosdesarrollocomunitario=new V({}),this.filesToUpload=new Map,this.totalBeneficiados=0,this.totalMontoInvertido=0}ngOnInit(){this.datosdesarrollocomunitario=this.formBuilder.group({programas:this.formBuilder.array([])}),this.agregarFilaPrograma("Programa de voluntariado corporativo"),this.agregarFilaPrograma("Tienda ECO"),this.agregarFilaPrograma("Donaciones e inversi\xF3n social"),this.datosdesarrollocomunitario.valueChanges.subscribe(()=>{this.calcularTotales()}),this.calcularTotales()}get programas(){return this.datosdesarrollocomunitario.get("programas")}agregarFilaPrograma(e=""){let t=this.formBuilder.group({nombre_programa:[e,g.required],cantidad_beneficiados:["",[g.required,g.min(0)]],monto_invertido:["",[g.required,g.min(0)]]});t.valueChanges.subscribe(()=>this.calcularTotales()),this.programas.push(t)}eliminarFilaPrograma(e){this.programas.length>1&&(this.programas.removeAt(e),this.calcularTotales())}calcularTotales(){this.totalBeneficiados=this.programas.controls.reduce((e,t)=>e+(Number(t.get("cantidad_beneficiados")?.value)||0),0),this.totalMontoInvertido=this.programas.controls.reduce((e,t)=>e+(Number(t.get("monto_invertido")?.value)||0),0)}getNumericValue(e){return Number(this.datosdesarrollocomunitario.get(e)?.value)||0}onFileSelected(e,t){let o=e.target.files[0];o&&(this.filesToUpload.set(t,o),console.log(`Archivo seleccionado: ${o.name} para ${t}`))}convertFileToBase64(e){return _(this,null,function*(){return new Promise((t,o)=>{let l=new FileReader;l.onload=()=>t(l.result),l.onerror=o,l.readAsDataURL(e)})})}submitFormDesarrolloComunitario(){return _(this,null,function*(){this.markFormGroupTouched(this.datosdesarrollocomunitario),this.datosdesarrollocomunitario.valid?(console.log("\u2705 Formulario Desarrollo Comunitario v\xE1lido"),yield this.sendAttachment()):(console.log("\u274C Formulario Desarrollo Comunitario inv\xE1lido"),this.scrollToFirstError(),alert("Por favor, complete todos los campos obligatorios"))})}sendAttachment(){return _(this,null,function*(){let e=[];for(let[l,W]of this.filesToUpload.entries()){console.log("\u{1F4CE} Procesando archivo:",l);let X=yield this.convertFileToBase64(W);e.push({fileName:l,fileData:X})}let t=this.formDataService.getDatosIniciales(),o=b(C({},this.datosdesarrollocomunitario.value),{totales:{beneficiados:this.totalBeneficiados,monto_invertido:this.totalMontoInvertido},fecha_reporte:new Date().toISOString()});console.log("\u{1F4CA} Datos a enviar:",o),this.formService.upload(e,t,null,null,null,null,null,null,null,null,null,null,null,null,o).subscribe({next:l=>{console.log("\u2705 Datos enviados exitosamente:",l),this.formDataService.clearDatosIniciales(),this.router.navigate(["/confirmacion"])},error:l=>{console.error("\u274C Error al enviar:",l),alert("Hubo un error al enviar los datos. Por favor, intente nuevamente.")}})})}static{this.\u0275fac=function(t){return new(t||n)(f(Y),f(Q),f(K),f(M))}}static{this.\u0275cmp=x({type:n,selectors:[["app-desarrollo-comunitario"]],standalone:!0,features:[D,y],decls:57,vars:8,consts:[[1,"form-header"],[1,"header-content"],["src","assets/logo.png","alt","Logo Empresa",1,"logo-empresa"],[1,"header-text"],["id","msform"],[1,"border-purple",3,"hidden"],[3,"ngSubmit","formGroup"],[1,"section-header"],[1,"icon"],[1,"fs-subtitle"],[1,"info-box"],[1,"subsection-header"],[1,"table-subtitle"],[1,"table-container"],[1,"gri-table","comunitario-table"],[1,"acciones-col"],["formArrayName","programas"],[3,"formGroupName",4,"ngFor","ngForOf"],[1,"totales-row"],[1,"total-label"],[1,"total-cell"],[1,"resultado-total"],[1,"resultado-total-final"],["type","button",1,"btn-agregar-fila",3,"click"],["type","button","value","GUARDAR Y ENVIAR",1,"action-button","success",3,"click"],[3,"formGroupName"],["type","text","formControlName","nombre_programa","placeholder","Nombre del programa",3,"ngClass"],["class","error-text",4,"ngIf"],["type","number","formControlName","cantidad_beneficiados","placeholder","0",3,"ngClass"],["type","number","formControlName","monto_invertido","placeholder","0",3,"ngClass"],[1,"acciones-cell"],["type","button","class","btn-eliminar","title","Eliminar fila",3,"click",4,"ngIf"],[1,"error-text"],["type","button","title","Eliminar fila",1,"btn-eliminar",3,"click"]],template:function(t,o){t&1&&(i(0,"div",0)(1,"div",1),p(2,"img",2),i(3,"div",3)(4,"h1"),a(5,"Plataforma de Gesti\xF3n - Informe de Sostenibilidad"),r(),i(6,"p"),a(7,"Sistema de recolecci\xF3n de datos para reportes GRI"),r()()()(),i(8,"form",4)(9,"fieldset",5)(10,"form",6),h("ngSubmit",function(){return o.submitFormDesarrolloComunitario()}),i(11,"div",7)(12,"span",8),a(13,"\u{1F91D}"),r(),i(14,"h2"),a(15,"Desarrollo Comunitario"),r()(),i(16,"p",9),a(17," Complete la informaci\xF3n sobre programas de desarrollo comunitario y relacionamiento con comunidades locales "),r(),i(18,"div",10)(19,"strong"),a(20,"\u2139\uFE0F INSTRUCCIONES:"),r(),a(21," Agregue filas seg\xFAn sea necesario para cada programa de desarrollo comunitario. Los totales se calcular\xE1n autom\xE1ticamente. "),r(),i(22,"div",11)(23,"span",8),a(24,"\u{1F30D}"),r(),a(25," DESARROLLO COMUNITARIO - Contenido GRI: 413-1 "),r(),i(26,"h3",12),a(27,"Programas de desarrollo comunitario y relacionamiento con comunidades locales"),r(),i(28,"div",13)(29,"table",14)(30,"thead")(31,"tr")(32,"th"),a(33,"Programas de desarrollo comunitario"),r(),i(34,"th"),a(35,"Cantidad de beneficiados"),r(),i(36,"th"),a(37,"Monto invertido ($)"),r(),i(38,"th",15),a(39,"Acciones"),r()()(),i(40,"tbody",16),u(41,ie,12,8,"tr",17),i(42,"tr",18)(43,"td",19)(44,"strong"),a(45,"Total"),r()(),i(46,"td",20)(47,"span",21),a(48),r()(),i(49,"td",20)(50,"span",22),a(51),N(52,"number"),r()(),p(53,"td"),r()()()(),i(54,"button",23),h("click",function(){return o.agregarFilaPrograma("")}),a(55," \u2795 Agregar programa "),r(),i(56,"input",24),h("click",function(){return o.submitFormDesarrolloComunitario()}),r()()()()),t&2&&(s(9),m("hidden",!o.desarrolloComunitario),s(),m("formGroup",o.datosdesarrollocomunitario),s(31),m("ngForOf",o.programas.controls),s(7),I(o.totalBeneficiados),s(3),v("$ ",T(52,5,o.totalMontoInvertido,"1.0-0"),""))},dependencies:[G,A,P,w,B,z,U,R,$,k,O,L,H,j,q]})}}return n})();export{pe as DesarrolloComunitarioComponent};

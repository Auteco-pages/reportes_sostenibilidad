import{a as ie}from"./chunk-2PSR7T7J.js";import{a as M,b as p,c as j,d as P,e as K,f as L,g as U,h as q,i as $,j as H,k as z,l as Y,m as J,n as Q,o as W,q as X,r as Z,s as ee,t as te}from"./chunk-6S4UDF73.js";import{B as s,C as f,F as b,G as C,I as c,K as n,L as t,M as u,N as x,O as A,P as y,Q as h,R as g,S as o,T as _,U as D,W as N,X as I,Y as T,Z as G,c as v,da as O,ea as w,fa as k,ga as B,ha as R,na as V,s as E,w as F,x as S}from"./chunk-ACHKL7EZ.js";var oe=(r,d)=>({"ng-invalid":r,"ng-valid":d});function re(r,d){if(r&1&&(n(0,"tr")(1,"td",29),o(2),t(),n(3,"td"),u(4,"input",30),t()()),r&2){let e,a=d.$implicit,i=g().ngIf,l=g();s(2),_(a),s(2),c("formControl",i.get(l.getContaminanteKey(a)))("ngClass",I(3,oe,((e=i.get(l.getContaminanteKey(a)))==null?null:e.invalid)&&((e=i.get(l.getContaminanteKey(a)))==null?null:e.touched),((e=i.get(l.getContaminanteKey(a)))==null?null:e.valid)&&((e=i.get(l.getContaminanteKey(a)))==null?null:e.touched)))}}function le(r,d){if(r&1&&(x(0),C(1,re,5,6,"tr",28),A()),r&2){let e=g();s(),c("ngForOf",e.contaminantesFijos)}}function se(r,d){if(r&1&&(n(0,"option",41),o(1),t()),r&2){let e=d.$implicit;c("value",e),s(),D(" ",e," ")}}function ce(r,d){if(r&1){let e=y();n(0,"button",42),h("click",function(){F(e);let i=g().index,l=g();return S(l.eliminarFilaAccion(i))}),o(1," \u274C "),t()}}function de(r,d){if(r&1&&(n(0,"tr",31)(1,"td"),u(2,"input",32),t(),n(3,"td")(4,"select",33)(5,"option",34),o(6,"Seleccione contaminante"),t(),C(7,se,2,2,"option",35),t()(),n(8,"td"),u(9,"textarea",36),t(),n(10,"td"),u(11,"textarea",37),t(),n(12,"td"),u(13,"input",38),t(),n(14,"td",39),C(15,ce,2,0,"button",40),t()()),r&2){let e=d.$implicit,a=d.index,i=g();c("formGroupName",a),s(2),c("ngClass",i.getFieldClass(e,"accion_implementada")),s(2),c("ngClass",i.getFieldClass(e,"contaminante_gestionado")),s(3),c("ngForOf",i.contaminantesFijos),s(2),c("ngClass",i.getFieldClass(e,"descripcion_acciones")),s(2),c("ngClass",i.getFieldClass(e,"descripcion_resultados")),s(2),c("ngClass",i.getFieldClass(e,"emisiones_evitadas")),s(2),c("ngIf",i.accionesGestion.length>1)}}var Ee=(()=>{class r extends ee{constructor(e,a,i,l){super(),this.formBuilder=e,this.formService=a,this.formDataService=i,this.router=l,this.calidadAire=!0,this.datoscalidadaire=new K({}),this.filesToUpload=new Map,this.contaminantesFijos=["\xD3xidos de nitr\xF3geno (NOx)","\xD3xidos de azufre (SOx)","Compuestos org\xE1nicos vol\xE1tiles (VOC)","Contaminantes peligrosos del aire (HAP)","Material particulado (PM10)","Material particulado primario (PM2.5)","Contaminantes org\xE1nicos persistentes (COP)","Amon\xEDaco (NH3)","Carbono negro (CN)","Carbono org\xE1nico (OC)","Mon\xF3xido de carbono (CO)","Metano (CH4)","Otros"],this.totalEmisionesEvitadas=0}ngOnInit(){this.datoscalidadaire=this.formBuilder.group({contaminantes:this.formBuilder.group({}),acciones_gestion:this.formBuilder.array([])}),this.inicializarContaminantes(),this.agregarFilaAccion(),this.datoscalidadaire.valueChanges.subscribe(()=>{this.calcularTotales()}),this.calcularTotales()}inicializarContaminantes(){let e=this.datoscalidadaire.get("contaminantes");this.contaminantesFijos.forEach(a=>{let i=this.getContaminanteKey(a);e.addControl(i,this.formBuilder.control("",[p.required,p.min(0)]))})}getContaminanteKey(e){return e.toLowerCase().replace(/\s+/g,"_").replace(/[()]/g,"").replace(/\./g,"")}getContaminanteValue(e){let a=this.getContaminanteKey(e);return Number(this.datoscalidadaire.get("contaminantes")?.get(a)?.value)||0}get accionesGestion(){return this.datoscalidadaire.get("acciones_gestion")}agregarFilaAccion(){let e=this.formBuilder.group({accion_implementada:["",p.required],contaminante_gestionado:["",p.required],descripcion_acciones:["",p.required],descripcion_resultados:["",p.required],emisiones_evitadas:["",[p.required,p.min(0)]]});e.valueChanges.subscribe(()=>this.calcularTotales()),this.accionesGestion.push(e)}eliminarFilaAccion(e){this.accionesGestion.length>1&&(this.accionesGestion.removeAt(e),this.calcularTotales())}calcularTotales(){this.totalEmisionesEvitadas=0,this.accionesGestion.controls.forEach(e=>{this.totalEmisionesEvitadas+=Number(e.get("emisiones_evitadas")?.value)||0})}getNumericValue(e){let a=this.datoscalidadaire.get(e)?.value;return Number(a)||0}onFileSelected(e,a){let i=e.target.files[0];i&&(this.filesToUpload.set(a,i),console.log(`Archivo seleccionado: ${i.name} para ${a}`))}convertFileToBase64(e){return v(this,null,function*(){return new Promise((a,i)=>{let l=new FileReader;l.onload=()=>a(l.result),l.onerror=i,l.readAsDataURL(e)})})}submitFormCalidadAire(){return v(this,null,function*(){this.markFormGroupTouched(this.datoscalidadaire),this.datoscalidadaire.valid?(console.log("\u2705 Formulario Calidad del Aire v\xE1lido"),yield this.sendAttachment()):(console.log("\u274C Formulario Calidad del Aire inv\xE1lido"),this.scrollToFirstError(),alert("Por favor, complete todos los campos obligatorios"))})}sendAttachment(){return v(this,null,function*(){let e=[];for(let[m,ne]of this.filesToUpload.entries()){console.log("\u{1F4CE} Procesando archivo:",m);let ae=yield this.convertFileToBase64(ne);e.push({fileName:m,fileData:ae})}let a=this.formDataService.getDatosIniciales(),i={};this.contaminantesFijos.forEach(m=>{i[m]=this.getContaminanteValue(m)});let l={contaminantes_atmosfericos:{datos:i},acciones_gestion_contaminantes:{datos:this.datoscalidadaire.value.acciones_gestion,totales:{total_emisiones_evitadas:this.totalEmisionesEvitadas}},metadata:{fecha_reporte:new Date().toISOString(),formulario_completo:this.datoscalidadaire.valid}};console.log("\u{1F4CA} Datos a enviar:",l),this.formService.upload(e,a,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,l).subscribe({next:m=>{console.log("\u2705 Datos enviados exitosamente:",m),this.formDataService.clearDatosIniciales(),this.router.navigate(["/confirmacion"])},error:m=>{console.error("\u274C Error al enviar:",m),alert("Hubo un error al enviar los datos. Por favor, intente nuevamente.")}})})}static{this.\u0275fac=function(a){return new(a||r)(f(X),f(ie),f(te),f(V))}}static{this.\u0275cmp=E({type:r,selectors:[["app-calidad-aire"]],standalone:!0,features:[b,N],decls:75,vars:8,consts:[[1,"form-header"],[1,"header-content"],["src","assets/logo.png","alt","Logo Empresa",1,"logo-empresa"],[1,"header-text"],["id","progressbar"],["id","msform"],[1,"border-green",3,"hidden"],[3,"ngSubmit","formGroup"],[1,"section-header"],[1,"icon"],[1,"fs-subtitle"],[1,"info-box"],[1,"subsection-header"],[1,"table-subtitle"],[1,"table-container"],[1,"gri-table","aire-table-contaminantes"],[4,"ngIf"],[1,"subsection-header",2,"margin-top","50px"],[1,"gri-table","aire-table-acciones"],[1,"acciones-col"],["formArrayName","acciones_gestion"],[3,"formGroupName",4,"ngFor","ngForOf"],[1,"totales-row"],["colspan","4",1,"total-label"],[1,"total-cell"],[1,"resultado-total-final"],["type","button",1,"btn-agregar-fila",3,"click"],["type","button","value","GUARDAR Y ENVIAR",1,"action-button","success",3,"click"],[4,"ngFor","ngForOf"],[1,"dato-label"],["type","number","step","0.01","placeholder","0.00",3,"formControl","ngClass"],[3,"formGroupName"],["type","text","formControlName","accion_implementada","placeholder","Acci\xF3n implementada",3,"ngClass"],["formControlName","contaminante_gestionado",3,"ngClass"],["value",""],[3,"value",4,"ngFor","ngForOf"],["formControlName","descripcion_acciones","placeholder","Descripci\xF3n de las acciones...","rows","3",3,"ngClass"],["formControlName","descripcion_resultados","placeholder","Descripci\xF3n de los resultados...","rows","3",3,"ngClass"],["type","number","formControlName","emisiones_evitadas","step","0.01","placeholder","0.00",3,"ngClass"],[1,"acciones-cell"],["type","button","class","btn-eliminar","title","Eliminar fila",3,"click",4,"ngIf"],[3,"value"],["type","button","title","Eliminar fila",1,"btn-eliminar",3,"click"]],template:function(a,i){a&1&&(n(0,"div",0)(1,"div",1),u(2,"img",2),n(3,"div",3)(4,"h1"),o(5,"Plataforma de Gesti\xF3n - Informe de Sostenibilidad"),t(),n(6,"p"),o(7,"Sistema de recolecci\xF3n de datos para reportes GRI"),t()()()(),u(8,"div",4),n(9,"form",5)(10,"fieldset",6)(11,"form",7),h("ngSubmit",function(){return i.submitFormCalidadAire()}),n(12,"div",8)(13,"span",9),o(14,"\u{1F32B}\uFE0F"),t(),n(15,"h2"),o(16,"Gesti\xF3n de la Calidad del Aire"),t()(),n(17,"p",10),o(18," Complete la informaci\xF3n sobre contaminantes atmosf\xE9ricos y acciones de gesti\xF3n "),t(),n(19,"div",11)(20,"strong"),o(21,"\u2139\uFE0F INSTRUCCIONES:"),t(),o(22," Complete las emisiones de cada contaminante atmosf\xE9rico y las acciones implementadas para su gesti\xF3n. "),t(),n(23,"div",12)(24,"span",9),o(25,"\u{1F4A8}"),t(),o(26," GESTI\xD3N DE LA CALIDAD DEL AIRE - Contenido GRI: 305-7 "),t(),n(27,"h3",13),o(28,"Contaminantes atmosf\xE9ricos"),t(),n(29,"div",14)(30,"table",15)(31,"thead")(32,"tr")(33,"th"),o(34,"Contaminante"),t(),n(35,"th"),o(36,"Emisiones (TON)"),t()()(),n(37,"tbody"),C(38,le,2,1,"ng-container",16),t()()(),n(39,"div",17)(40,"span",9),o(41,"\u{1F3AF}"),t(),o(42," ACCIONES DE GESTI\xD3N - Contenido GRI: N/A "),t(),n(43,"h3",13),o(44,"Acciones implementadas para la gesti\xF3n de contaminantes atmosf\xE9ricos"),t(),n(45,"div",14)(46,"table",18)(47,"thead")(48,"tr")(49,"th"),o(50,"Acci\xF3n implementada"),t(),n(51,"th"),o(52,"Contaminante gestionado"),t(),n(53,"th"),o(54,"Descripci\xF3n de las acciones y su objetivo"),t(),n(55,"th"),o(56,"Descripci\xF3n de los resultados obtenidos"),t(),n(57,"th"),o(58,"Emisiones evitadas (TON)"),t(),n(59,"th",19),o(60,"Acciones"),t()()(),n(61,"tbody",20),C(62,de,16,8,"tr",21),n(63,"tr",22)(64,"td",23)(65,"strong"),o(66,"TOTAL"),t()(),n(67,"td",24)(68,"span",25),o(69),T(70,"number"),t()(),u(71,"td"),t()()()(),n(72,"button",26),h("click",function(){return i.agregarFilaAccion()}),o(73," \u2795 Agregar acci\xF3n de gesti\xF3n "),t(),n(74,"input",27),h("click",function(){return i.submitFormCalidadAire()}),t()()()()),a&2&&(s(10),c("hidden",!i.calidadAire),s(),c("formGroup",i.datoscalidadaire),s(27),c("ngIf",i.datoscalidadaire.get("contaminantes")),s(24),c("ngForOf",i.accionesGestion.controls),s(7),_(G(70,5,i.totalEmisionesEvitadas,"1.2-2")))},dependencies:[R,O,w,k,B,Z,L,Q,W,M,U,J,j,P,q,$,Y,H,z]})}}return r})();export{Ee as CalidadAireComponent};

import{a as W}from"./chunk-2PSR7T7J.js";import{a as R,b as u,c as U,d as q,e as L,f as M,g as P,i as $,j,k as H,l as Y,q as z,r as J,s as K,t as Q}from"./chunk-6S4UDF73.js";import{B as l,C as _,F as D,G as f,I as s,K as t,L as e,M as m,P as b,Q as g,R as p,S as n,T as E,U as F,W as I,Y as S,Z as x,a as y,b as T,c as v,da as V,ea as G,fa as k,ga as w,ha as B,na as O,s as N,w as C,x as A}from"./chunk-ACHKL7EZ.js";function Z(c,d){if(c&1){let i=b();t(0,"button",40),g("click",function(){C(i);let a=p().index,o=p();return A(o.eliminarFilaConsumoAgua(a))}),n(1," \u274C "),e()}}function ee(c,d){if(c&1&&(t(0,"tr",32)(1,"td"),m(2,"input",33),e(),t(3,"td"),m(4,"input",34),e(),t(5,"td"),m(6,"input",35),e(),t(7,"td",36)(8,"span",37),n(9),S(10,"number"),e()(),t(11,"td",38),f(12,Z,2,0,"button",39),e()()),c&2){let i=d.$implicit,r=d.index,a=p();s("formGroupName",r),l(2),s("ngClass",a.getFieldClass(i,"empresa")),l(2),s("ngClass",a.getFieldClass(i,"consumo_actual")),l(2),s("ngClass",a.getFieldClass(i,"consumo_anterior")),l(3),F("",x(10,6,a.getVariacionEmpresa(r),"1.2-2"),"%"),l(3),s("ngIf",a.consumoAgua.length>1)}}function te(c,d){if(c&1){let i=b();t(0,"button",40),g("click",function(){C(i);let a=p().index,o=p();return A(o.eliminarFilaEficiencia(a))}),n(1," \u274C "),e()}}function ie(c,d){if(c&1&&(t(0,"tr",32)(1,"td"),m(2,"input",41),e(),t(3,"td"),m(4,"textarea",42),e(),t(5,"td"),m(6,"textarea",43),e(),t(7,"td"),m(8,"input",44),e(),t(9,"td",38),f(10,te,2,0,"button",39),e()()),c&2){let i=d.$implicit,r=d.index,a=p();s("formGroupName",r),l(2),s("ngClass",a.getFieldClass(i,"accion_implementada")),l(2),s("ngClass",a.getFieldClass(i,"descripcion_acciones")),l(2),s("ngClass",a.getFieldClass(i,"descripcion_resultados")),l(2),s("ngClass",a.getFieldClass(i,"ahorros_agua")),l(2),s("ngIf",a.accionesEficiencia.length>1)}}function ae(c,d){if(c&1){let i=b();t(0,"button",40),g("click",function(){C(i);let a=p().index,o=p();return A(o.eliminarFilaVertimientos(a))}),n(1," \u274C "),e()}}function ne(c,d){if(c&1&&(t(0,"tr",32)(1,"td"),m(2,"input",33),e(),t(3,"td"),m(4,"input",45),e(),t(5,"td",38),f(6,ae,2,0,"button",39),e()()),c&2){let i=d.$implicit,r=d.index,a=p();s("formGroupName",r),l(2),s("ngClass",a.getFieldClass(i,"empresa")),l(2),s("ngClass",a.getFieldClass(i,"agua_vertida")),l(2),s("ngIf",a.vertimientosAgua.length>1)}}var ge=(()=>{class c extends K{constructor(i,r,a,o){super(),this.formBuilder=i,this.formService=r,this.formDataService=a,this.router=o,this.eficienciaAgua=!0,this.datoseficienciaagua=new L({}),this.filesToUpload=new Map,this.totalConsumoActual=0,this.totalConsumoAnterior=0,this.variacionEmpresas={},this.totalAhorrosAgua=0,this.totalVertimientos=0}ngOnInit(){this.datoseficienciaagua=this.formBuilder.group({consumo_agua:this.formBuilder.array([]),acciones_eficiencia:this.formBuilder.array([]),vertimientos_agua:this.formBuilder.array([])}),this.agregarFilaConsumoAgua(),this.agregarFilaEficiencia(),this.agregarFilaVertimientos(),this.datoseficienciaagua.valueChanges.subscribe(()=>{this.calcularTotales()}),this.calcularTotales()}get consumoAgua(){return this.datoseficienciaagua.get("consumo_agua")}agregarFilaConsumoAgua(){let i=this.formBuilder.group({empresa:["",u.required],consumo_actual:["",[u.required,u.min(0)]],consumo_anterior:["",[u.required,u.min(0)]]});i.valueChanges.subscribe(()=>this.calcularTotales()),this.consumoAgua.push(i)}eliminarFilaConsumoAgua(i){this.consumoAgua.length>1&&(this.consumoAgua.removeAt(i),this.calcularTotales())}get accionesEficiencia(){return this.datoseficienciaagua.get("acciones_eficiencia")}agregarFilaEficiencia(){let i=this.formBuilder.group({accion_implementada:["",u.required],descripcion_acciones:["",u.required],descripcion_resultados:["",u.required],ahorros_agua:["",[u.required,u.min(0)]]});i.valueChanges.subscribe(()=>this.calcularTotales()),this.accionesEficiencia.push(i)}eliminarFilaEficiencia(i){this.accionesEficiencia.length>1&&(this.accionesEficiencia.removeAt(i),this.calcularTotales())}get vertimientosAgua(){return this.datoseficienciaagua.get("vertimientos_agua")}agregarFilaVertimientos(){let i=this.formBuilder.group({empresa:["",u.required],agua_vertida:["",[u.required,u.min(0)]]});i.valueChanges.subscribe(()=>this.calcularTotales()),this.vertimientosAgua.push(i)}eliminarFilaVertimientos(i){this.vertimientosAgua.length>1&&(this.vertimientosAgua.removeAt(i),this.calcularTotales())}calcularTotales(){this.totalConsumoActual=0,this.totalConsumoAnterior=0,this.variacionEmpresas={},this.consumoAgua.controls.forEach((i,r)=>{let a=Number(i.get("consumo_actual")?.value)||0,o=Number(i.get("consumo_anterior")?.value)||0,h=i.get("empresa")?.value||`empresa_${r}`;this.totalConsumoActual+=a,this.totalConsumoAnterior+=o,o>0?this.variacionEmpresas[h]=(a-o)/o*100:this.variacionEmpresas[h]=0}),this.totalAhorrosAgua=0,this.accionesEficiencia.controls.forEach(i=>{this.totalAhorrosAgua+=Number(i.get("ahorros_agua")?.value)||0}),this.totalVertimientos=0,this.vertimientosAgua.controls.forEach(i=>{this.totalVertimientos+=Number(i.get("agua_vertida")?.value)||0})}calcularVariacionTotal(){return this.totalConsumoAnterior>0?(this.totalConsumoActual-this.totalConsumoAnterior)/this.totalConsumoAnterior*100:0}getVariacionEmpresa(i){let a=this.consumoAgua.at(i).get("empresa")?.value||`empresa_${i}`;return this.variacionEmpresas[a]||0}getNumericValue(i){let r=this.datoseficienciaagua.get(i)?.value;return Number(r)||0}onFileSelected(i,r){let a=i.target.files[0];a&&(this.filesToUpload.set(r,a),console.log(`Archivo seleccionado: ${a.name} para ${r}`))}convertFileToBase64(i){return v(this,null,function*(){return new Promise((r,a)=>{let o=new FileReader;o.onload=()=>r(o.result),o.onerror=a,o.readAsDataURL(i)})})}submitFormEficienciaAgua(){return v(this,null,function*(){this.markFormGroupTouched(this.datoseficienciaagua),this.datoseficienciaagua.valid?(console.log("\u2705 Formulario Eficiencia en el Uso del Agua v\xE1lido"),yield this.sendAttachment()):(console.log("\u274C Formulario Eficiencia en el Uso del Agua inv\xE1lido"),this.scrollToFirstError(),alert("Por favor, complete todos los campos obligatorios"))})}sendAttachment(){return v(this,null,function*(){let i=[];for(let[o,h]of this.filesToUpload.entries()){console.log("\u{1F4CE} Procesando archivo:",o);let X=yield this.convertFileToBase64(h);i.push({fileName:o,fileData:X})}let r=this.formDataService.getDatosIniciales(),a={consumo_agua_grupo:{datos:this.datoseficienciaagua.value.consumo_agua.map((o,h)=>T(y({},o),{variacion_porcentual:this.getVariacionEmpresa(h)})),totales:{total_consumo_actual:this.totalConsumoActual,total_consumo_anterior:this.totalConsumoAnterior,variacion_total:this.calcularVariacionTotal()}},acciones_eficiencia_agua:{datos:this.datoseficienciaagua.value.acciones_eficiencia,totales:{total_ahorros_agua:this.totalAhorrosAgua}},vertimientos_agua:{datos:this.datoseficienciaagua.value.vertimientos_agua,totales:{total_vertimientos:this.totalVertimientos}},metadata:{fecha_reporte:new Date().toISOString(),formulario_completo:this.datoseficienciaagua.valid}};console.log("\u{1F4CA} Datos a enviar:",a),this.formService.upload(i,r,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,a).subscribe({next:o=>{console.log("\u2705 Datos enviados exitosamente:",o),this.formDataService.clearDatosIniciales(),this.router.navigate(["/confirmacion"])},error:o=>{console.error("\u274C Error al enviar:",o),alert("Hubo un error al enviar los datos. Por favor, intente nuevamente.")}})})}static{this.\u0275fac=function(r){return new(r||c)(_(z),_(W),_(Q),_(O))}}static{this.\u0275cmp=N({type:c,selectors:[["app-eficiencia-agua"]],standalone:!0,features:[D,I],decls:124,vars:16,consts:[[1,"form-header"],[1,"header-content"],["src","assets/logo.png","alt","Logo Empresa",1,"logo-empresa"],[1,"header-text"],["id","progressbar"],["id","msform"],[1,"border-green",3,"hidden"],[3,"ngSubmit","formGroup"],[1,"section-header"],[1,"icon"],[1,"fs-subtitle"],[1,"info-box"],[1,"subsection-header"],[1,"table-subtitle"],[1,"table-container"],[1,"gri-table","agua-table-consumo"],[1,"acciones-col"],["formArrayName","consumo_agua"],[3,"formGroupName",4,"ngFor","ngForOf"],[1,"totales-row"],[1,"total-label"],[1,"total-cell"],[1,"resultado-total"],[1,"resultado-total-final"],["type","button",1,"btn-agregar-fila",3,"click"],[1,"subsection-header",2,"margin-top","50px"],[1,"gri-table","agua-table-acciones"],["formArrayName","acciones_eficiencia"],["colspan","3",1,"total-label"],[1,"gri-table","agua-table-vertimientos"],["formArrayName","vertimientos_agua"],["type","button","value","GUARDAR Y ENVIAR",1,"action-button","success",3,"click"],[3,"formGroupName"],["type","text","formControlName","empresa","placeholder","Nombre de la empresa",3,"ngClass"],["type","number","formControlName","consumo_actual","step","0.01","placeholder","0",3,"ngClass"],["type","number","formControlName","consumo_anterior","step","0.01","placeholder","0",3,"ngClass"],[1,"valor-calculado"],[1,"resultado"],[1,"acciones-cell"],["type","button","class","btn-eliminar","title","Eliminar fila",3,"click",4,"ngIf"],["type","button","title","Eliminar fila",1,"btn-eliminar",3,"click"],["type","text","formControlName","accion_implementada","placeholder","Acci\xF3n implementada",3,"ngClass"],["formControlName","descripcion_acciones","placeholder","Descripci\xF3n de las acciones...","rows","3",3,"ngClass"],["formControlName","descripcion_resultados","placeholder","Descripci\xF3n de los resultados...","rows","3",3,"ngClass"],["type","number","formControlName","ahorros_agua","step","0.01","placeholder","0.00",3,"ngClass"],["type","number","formControlName","agua_vertida","step","0.01","placeholder","0",3,"ngClass"]],template:function(r,a){r&1&&(t(0,"div",0)(1,"div",1),m(2,"img",2),t(3,"div",3)(4,"h1"),n(5,"Plataforma de Gesti\xF3n - Informe de Sostenibilidad"),e(),t(6,"p"),n(7,"Sistema de recolecci\xF3n de datos para reportes GRI"),e()()()(),m(8,"div",4),t(9,"form",5)(10,"fieldset",6)(11,"form",7),g("ngSubmit",function(){return a.submitFormEficienciaAgua()}),t(12,"div",8)(13,"span",9),n(14,"\u{1F4A7}"),e(),t(15,"h2"),n(16,"Consumo de Energ\xEDa Grupo Auteco"),e()(),t(17,"p",10),n(18," Complete la informaci\xF3n sobre consumo de agua, acciones de eficiencia y vertimientos "),e(),t(19,"div",11)(20,"strong"),n(21,"\u2139\uFE0F INSTRUCCIONES:"),e(),n(22," Complete todas las secciones sobre consumo y gesti\xF3n del agua. "),e(),t(23,"div",12)(24,"span",9),n(25,"\u{1F4A7}"),e(),n(26," CONSUMO DE ENERG\xCDA GRUPO AUTECO - Contenido GRI: 303-5 "),e(),t(27,"h3",13),n(28,"Consumo de agua y variaci\xF3n respecto al a\xF1o anterior"),e(),t(29,"div",14)(30,"table",15)(31,"thead")(32,"tr")(33,"th"),n(34,"Empresa"),e(),t(35,"th"),n(36,"Consumo de agua a\xF1o actual (m3)"),e(),t(37,"th"),n(38,"Consumo de agua a\xF1o anterior (m3)"),e(),t(39,"th"),n(40,"Variaci\xF3n (%)"),e(),t(41,"th",16),n(42,"Acciones"),e()()(),t(43,"tbody",17),f(44,ee,13,9,"tr",18),t(45,"tr",19)(46,"td",20)(47,"strong"),n(48,"TOTAL"),e()(),t(49,"td",21)(50,"span",22),n(51),e()(),t(52,"td",21)(53,"span",22),n(54),e()(),t(55,"td",21)(56,"span",23),n(57),S(58,"number"),e()(),m(59,"td"),e()()()(),t(60,"button",24),g("click",function(){return a.agregarFilaConsumoAgua()}),n(61," \u2795 Agregar empresa "),e(),t(62,"div",25)(63,"span",9),n(64,"\u{1F30A}"),e(),n(65," EFICIENCIA EN EL USO DEL AGUA - Contenido GRI: N/A "),e(),t(66,"h3",13),n(67,"Acciones implementadas de eficiencia en el uso del agua"),e(),t(68,"div",14)(69,"table",26)(70,"thead")(71,"tr")(72,"th"),n(73,"Acci\xF3n implementada"),e(),t(74,"th"),n(75,"Descripci\xF3n de las acciones y su objetivo"),e(),t(76,"th"),n(77,"Descripci\xF3n de los resultados obtenidos"),e(),t(78,"th"),n(79,"Ahorros de energ\xEDa agua generados (m3)"),e(),t(80,"th",16),n(81,"Acciones"),e()()(),t(82,"tbody",27),f(83,ie,11,6,"tr",18),t(84,"tr",19)(85,"td",28)(86,"strong"),n(87,"TOTAL"),e()(),t(88,"td",21)(89,"span",23),n(90),S(91,"number"),e()(),m(92,"td"),e()()()(),t(93,"button",24),g("click",function(){return a.agregarFilaEficiencia()}),n(94," \u2795 Agregar acci\xF3n de eficiencia "),e(),t(95,"div",25)(96,"span",9),n(97,"\u{1F6B0}"),e(),n(98," GESTI\xD3N DE VERTIMIENTOS DE AGUA - Contenido GRI: 303-4 "),e(),t(99,"h3",13),n(100,"Vertimientos de agua (m3)"),e(),t(101,"div",14)(102,"table",29)(103,"thead")(104,"tr")(105,"th"),n(106,"Empresa"),e(),t(107,"th"),n(108,"Agua vertida (m3)"),e(),t(109,"th",16),n(110,"Acciones"),e()()(),t(111,"tbody",30),f(112,ne,7,4,"tr",18),t(113,"tr",19)(114,"td",20)(115,"strong"),n(116,"TOTAL"),e()(),t(117,"td",21)(118,"span",23),n(119),e()(),m(120,"td"),e()()()(),t(121,"button",24),g("click",function(){return a.agregarFilaVertimientos()}),n(122," \u2795 Agregar empresa "),e(),t(123,"input",31),g("click",function(){return a.submitFormEficienciaAgua()}),e()()()()),r&2&&(l(10),s("hidden",!a.eficienciaAgua),l(),s("formGroup",a.datoseficienciaagua),l(33),s("ngForOf",a.consumoAgua.controls),l(7),E(a.totalConsumoActual),l(3),E(a.totalConsumoAnterior),l(3),F("",x(58,10,a.calcularVariacionTotal(),"1.2-2"),"%"),l(26),s("ngForOf",a.accionesEficiencia.controls),l(7),E(x(91,13,a.totalAhorrosAgua,"1.2-2")),l(22),s("ngForOf",a.vertimientosAgua.controls),l(7),E(a.totalVertimientos))},dependencies:[B,V,G,k,w,J,M,R,P,U,q,$,Y,j,H]})}}return c})();export{ge as EficienciaAguaComponent};

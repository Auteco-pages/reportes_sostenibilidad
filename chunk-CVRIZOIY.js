import{a as W}from"./chunk-2PSR7T7J.js";import{a as R,b as u,c as U,d as q,e as L,f as M,g as P,i as $,j,k as H,l as Y,q as z,r as J,s as K,t as Q}from"./chunk-6S4UDF73.js";import{B as l,C as _,F as D,G as f,I as s,K as t,L as e,M as m,P as b,Q as g,R as p,S as n,T as E,U as F,W as I,Y as S,Z as x,a as y,b as T,c as v,da as V,ea as G,fa as k,ga as w,ha as B,na as O,s as N,w as C,x as A}from"./chunk-ACHKL7EZ.js";function Z(c,d){if(c&1){let i=b();t(0,"button",39),g("click",function(){C(i);let a=p().index,o=p();return A(o.eliminarFilaConsumoAgua(a))}),n(1," \u274C "),e()}}function ee(c,d){if(c&1&&(t(0,"tr",31)(1,"td"),m(2,"input",32),e(),t(3,"td"),m(4,"input",33),e(),t(5,"td"),m(6,"input",34),e(),t(7,"td",35)(8,"span",36),n(9),S(10,"number"),e()(),t(11,"td",37),f(12,Z,2,0,"button",38),e()()),c&2){let i=d.$implicit,r=d.index,a=p();s("formGroupName",r),l(2),s("ngClass",a.getFieldClass(i,"empresa")),l(2),s("ngClass",a.getFieldClass(i,"consumo_actual")),l(2),s("ngClass",a.getFieldClass(i,"consumo_anterior")),l(3),F("",x(10,6,a.getVariacionEmpresa(r),"1.2-2"),"%"),l(3),s("ngIf",a.consumoAgua.length>1)}}function te(c,d){if(c&1){let i=b();t(0,"button",39),g("click",function(){C(i);let a=p().index,o=p();return A(o.eliminarFilaEficiencia(a))}),n(1," \u274C "),e()}}function ie(c,d){if(c&1&&(t(0,"tr",31)(1,"td"),m(2,"input",40),e(),t(3,"td"),m(4,"textarea",41),e(),t(5,"td"),m(6,"textarea",42),e(),t(7,"td"),m(8,"input",43),e(),t(9,"td",37),f(10,te,2,0,"button",38),e()()),c&2){let i=d.$implicit,r=d.index,a=p();s("formGroupName",r),l(2),s("ngClass",a.getFieldClass(i,"accion_implementada")),l(2),s("ngClass",a.getFieldClass(i,"descripcion_acciones")),l(2),s("ngClass",a.getFieldClass(i,"descripcion_resultados")),l(2),s("ngClass",a.getFieldClass(i,"ahorros_agua")),l(2),s("ngIf",a.accionesEficiencia.length>1)}}function ae(c,d){if(c&1){let i=b();t(0,"button",39),g("click",function(){C(i);let a=p().index,o=p();return A(o.eliminarFilaVertimientos(a))}),n(1," \u274C "),e()}}function ne(c,d){if(c&1&&(t(0,"tr",31)(1,"td"),m(2,"input",32),e(),t(3,"td"),m(4,"input",44),e(),t(5,"td",37),f(6,ae,2,0,"button",38),e()()),c&2){let i=d.$implicit,r=d.index,a=p();s("formGroupName",r),l(2),s("ngClass",a.getFieldClass(i,"empresa")),l(2),s("ngClass",a.getFieldClass(i,"agua_vertida")),l(2),s("ngIf",a.vertimientosAgua.length>1)}}var ge=(()=>{class c extends K{constructor(i,r,a,o){super(),this.formBuilder=i,this.formService=r,this.formDataService=a,this.router=o,this.eficienciaAgua=!0,this.datoseficienciaagua=new L({}),this.filesToUpload=new Map,this.totalConsumoActual=0,this.totalConsumoAnterior=0,this.variacionEmpresas={},this.totalAhorrosAgua=0,this.totalVertimientos=0}ngOnInit(){this.datoseficienciaagua=this.formBuilder.group({consumo_agua:this.formBuilder.array([]),acciones_eficiencia:this.formBuilder.array([]),vertimientos_agua:this.formBuilder.array([])}),this.agregarFilaConsumoAgua(),this.agregarFilaEficiencia(),this.agregarFilaVertimientos(),this.datoseficienciaagua.valueChanges.subscribe(()=>{this.calcularTotales()}),this.calcularTotales()}get consumoAgua(){return this.datoseficienciaagua.get("consumo_agua")}agregarFilaConsumoAgua(){let i=this.formBuilder.group({empresa:["",u.required],consumo_actual:["",[u.required,u.min(0)]],consumo_anterior:["",[u.required,u.min(0)]]});i.valueChanges.subscribe(()=>this.calcularTotales()),this.consumoAgua.push(i)}eliminarFilaConsumoAgua(i){this.consumoAgua.length>1&&(this.consumoAgua.removeAt(i),this.calcularTotales())}get accionesEficiencia(){return this.datoseficienciaagua.get("acciones_eficiencia")}agregarFilaEficiencia(){let i=this.formBuilder.group({accion_implementada:["",u.required],descripcion_acciones:["",u.required],descripcion_resultados:["",u.required],ahorros_agua:["",[u.required,u.min(0)]]});i.valueChanges.subscribe(()=>this.calcularTotales()),this.accionesEficiencia.push(i)}eliminarFilaEficiencia(i){this.accionesEficiencia.length>1&&(this.accionesEficiencia.removeAt(i),this.calcularTotales())}get vertimientosAgua(){return this.datoseficienciaagua.get("vertimientos_agua")}agregarFilaVertimientos(){let i=this.formBuilder.group({empresa:["",u.required],agua_vertida:["",[u.required,u.min(0)]]});i.valueChanges.subscribe(()=>this.calcularTotales()),this.vertimientosAgua.push(i)}eliminarFilaVertimientos(i){this.vertimientosAgua.length>1&&(this.vertimientosAgua.removeAt(i),this.calcularTotales())}calcularTotales(){this.totalConsumoActual=0,this.totalConsumoAnterior=0,this.variacionEmpresas={},this.consumoAgua.controls.forEach((i,r)=>{let a=Number(i.get("consumo_actual")?.value)||0,o=Number(i.get("consumo_anterior")?.value)||0,h=i.get("empresa")?.value||`empresa_${r}`;this.totalConsumoActual+=a,this.totalConsumoAnterior+=o,o>0?this.variacionEmpresas[h]=(a-o)/o*100:this.variacionEmpresas[h]=0}),this.totalAhorrosAgua=0,this.accionesEficiencia.controls.forEach(i=>{this.totalAhorrosAgua+=Number(i.get("ahorros_agua")?.value)||0}),this.totalVertimientos=0,this.vertimientosAgua.controls.forEach(i=>{this.totalVertimientos+=Number(i.get("agua_vertida")?.value)||0})}calcularVariacionTotal(){return this.totalConsumoAnterior>0?(this.totalConsumoActual-this.totalConsumoAnterior)/this.totalConsumoAnterior*100:0}getVariacionEmpresa(i){let a=this.consumoAgua.at(i).get("empresa")?.value||`empresa_${i}`;return this.variacionEmpresas[a]||0}getNumericValue(i){let r=this.datoseficienciaagua.get(i)?.value;return Number(r)||0}onFileSelected(i,r){let a=i.target.files[0];a&&(this.filesToUpload.set(r,a),console.log(`Archivo seleccionado: ${a.name} para ${r}`))}convertFileToBase64(i){return v(this,null,function*(){return new Promise((r,a)=>{let o=new FileReader;o.onload=()=>r(o.result),o.onerror=a,o.readAsDataURL(i)})})}submitFormEficienciaAgua(){return v(this,null,function*(){this.markFormGroupTouched(this.datoseficienciaagua),this.datoseficienciaagua.valid?(console.log("\u2705 Formulario Eficiencia en el Uso del Agua v\xE1lido"),yield this.sendAttachment()):(console.log("\u274C Formulario Eficiencia en el Uso del Agua inv\xE1lido"),this.scrollToFirstError(),alert("Por favor, complete todos los campos obligatorios"))})}sendAttachment(){return v(this,null,function*(){let i=[];for(let[o,h]of this.filesToUpload.entries()){console.log("\u{1F4CE} Procesando archivo:",o);let X=yield this.convertFileToBase64(h);i.push({fileName:o,fileData:X})}let r=this.formDataService.getDatosIniciales(),a={consumo_agua_grupo:{datos:this.datoseficienciaagua.value.consumo_agua.map((o,h)=>T(y({},o),{variacion_porcentual:this.getVariacionEmpresa(h)})),totales:{total_consumo_actual:this.totalConsumoActual,total_consumo_anterior:this.totalConsumoAnterior,variacion_total:this.calcularVariacionTotal()}},acciones_eficiencia_agua:{datos:this.datoseficienciaagua.value.acciones_eficiencia,totales:{total_ahorros_agua:this.totalAhorrosAgua}},vertimientos_agua:{datos:this.datoseficienciaagua.value.vertimientos_agua,totales:{total_vertimientos:this.totalVertimientos}},metadata:{fecha_reporte:new Date().toISOString(),formulario_completo:this.datoseficienciaagua.valid}};console.log("\u{1F4CA} Datos a enviar:",a),this.formService.upload(i,r,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,a).subscribe({next:o=>{console.log("\u2705 Datos enviados exitosamente:",o),this.formDataService.clearDatosIniciales(),this.router.navigate(["/confirmacion"])},error:o=>{console.error("\u274C Error al enviar:",o),alert("Hubo un error al enviar los datos. Por favor, intente nuevamente.")}})})}static{this.\u0275fac=function(r){return new(r||c)(_(z),_(W),_(Q),_(O))}}static{this.\u0275cmp=N({type:c,selectors:[["app-eficiencia-agua"]],standalone:!0,features:[D,I],decls:123,vars:16,consts:[[1,"form-header"],[1,"header-content"],[1,"header-text"],["src","assets/auteco-logo.png","alt","Logo Empresa",1,"logo-empresa"],["id","msform"],[1,"border-green",3,"hidden"],[3,"ngSubmit","formGroup"],[1,"section-header"],[1,"icon"],[1,"fs-subtitle"],[1,"info-box"],[1,"subsection-header"],[1,"table-subtitle"],[1,"table-container"],[1,"gri-table","agua-table-consumo"],[1,"acciones-col"],["formArrayName","consumo_agua"],[3,"formGroupName",4,"ngFor","ngForOf"],[1,"totales-row"],[1,"total-label"],[1,"total-cell"],[1,"resultado-total"],[1,"resultado-total-final"],["type","button",1,"btn-agregar-fila",3,"click"],[1,"subsection-header",2,"margin-top","50px"],[1,"gri-table","agua-table-acciones"],["formArrayName","acciones_eficiencia"],["colspan","3",1,"total-label"],[1,"gri-table","agua-table-vertimientos"],["formArrayName","vertimientos_agua"],["type","button","value","GUARDAR Y ENVIAR",1,"action-button","success",3,"click"],[3,"formGroupName"],["type","text","formControlName","empresa","placeholder","Nombre de la empresa",3,"ngClass"],["type","number","formControlName","consumo_actual","step","0.01","placeholder","0",3,"ngClass"],["type","number","formControlName","consumo_anterior","step","0.01","placeholder","0",3,"ngClass"],[1,"valor-calculado"],[1,"resultado"],[1,"acciones-cell"],["type","button","class","btn-eliminar","title","Eliminar fila",3,"click",4,"ngIf"],["type","button","title","Eliminar fila",1,"btn-eliminar",3,"click"],["type","text","formControlName","accion_implementada","placeholder","Acci\xF3n implementada",3,"ngClass"],["formControlName","descripcion_acciones","placeholder","Descripci\xF3n de las acciones...","rows","3",3,"ngClass"],["formControlName","descripcion_resultados","placeholder","Descripci\xF3n de los resultados...","rows","3",3,"ngClass"],["type","number","formControlName","ahorros_agua","step","0.01","placeholder","0.00",3,"ngClass"],["type","number","formControlName","agua_vertida","step","0.01","placeholder","0",3,"ngClass"]],template:function(r,a){r&1&&(t(0,"div",0)(1,"div",1)(2,"div",2)(3,"h1"),m(4,"img",3),n(5," Plataforma de Gesti\xF3n - Informe de Sostenibilidad"),e(),t(6,"p"),n(7,"Sistema de recolecci\xF3n de datos para reportes GRI"),e()()()(),t(8,"form",4)(9,"fieldset",5)(10,"form",6),g("ngSubmit",function(){return a.submitFormEficienciaAgua()}),t(11,"div",7)(12,"span",8),n(13,"\u{1F4A7}"),e(),t(14,"h2"),n(15,"Consumo de Energ\xEDa Grupo Auteco"),e()(),t(16,"p",9),n(17," Complete la informaci\xF3n sobre consumo de agua, acciones de eficiencia y vertimientos "),e(),t(18,"div",10)(19,"strong"),n(20,"\u2139\uFE0F INSTRUCCIONES:"),e(),n(21," Complete todas las secciones sobre consumo y gesti\xF3n del agua. "),e(),t(22,"div",11)(23,"span",8),n(24,"\u{1F4A7}"),e(),n(25," CONSUMO DE ENERG\xCDA GRUPO AUTECO - Contenido GRI: 303-5 "),e(),t(26,"h3",12),n(27,"Consumo de agua y variaci\xF3n respecto al a\xF1o anterior"),e(),t(28,"div",13)(29,"table",14)(30,"thead")(31,"tr")(32,"th"),n(33,"Empresa"),e(),t(34,"th"),n(35,"Consumo de agua a\xF1o actual (m3)"),e(),t(36,"th"),n(37,"Consumo de agua a\xF1o anterior (m3)"),e(),t(38,"th"),n(39,"Variaci\xF3n (%)"),e(),t(40,"th",15),n(41,"Acciones"),e()()(),t(42,"tbody",16),f(43,ee,13,9,"tr",17),t(44,"tr",18)(45,"td",19)(46,"strong"),n(47,"TOTAL"),e()(),t(48,"td",20)(49,"span",21),n(50),e()(),t(51,"td",20)(52,"span",21),n(53),e()(),t(54,"td",20)(55,"span",22),n(56),S(57,"number"),e()(),m(58,"td"),e()()()(),t(59,"button",23),g("click",function(){return a.agregarFilaConsumoAgua()}),n(60," \u2795 Agregar empresa "),e(),t(61,"div",24)(62,"span",8),n(63,"\u{1F30A}"),e(),n(64," EFICIENCIA EN EL USO DEL AGUA - Contenido GRI: N/A "),e(),t(65,"h3",12),n(66,"Acciones implementadas de eficiencia en el uso del agua"),e(),t(67,"div",13)(68,"table",25)(69,"thead")(70,"tr")(71,"th"),n(72,"Acci\xF3n implementada"),e(),t(73,"th"),n(74,"Descripci\xF3n de las acciones y su objetivo"),e(),t(75,"th"),n(76,"Descripci\xF3n de los resultados obtenidos"),e(),t(77,"th"),n(78,"Ahorros de energ\xEDa agua generados (m3)"),e(),t(79,"th",15),n(80,"Acciones"),e()()(),t(81,"tbody",26),f(82,ie,11,6,"tr",17),t(83,"tr",18)(84,"td",27)(85,"strong"),n(86,"TOTAL"),e()(),t(87,"td",20)(88,"span",22),n(89),S(90,"number"),e()(),m(91,"td"),e()()()(),t(92,"button",23),g("click",function(){return a.agregarFilaEficiencia()}),n(93," \u2795 Agregar acci\xF3n de eficiencia "),e(),t(94,"div",24)(95,"span",8),n(96,"\u{1F6B0}"),e(),n(97," GESTI\xD3N DE VERTIMIENTOS DE AGUA - Contenido GRI: 303-4 "),e(),t(98,"h3",12),n(99,"Vertimientos de agua (m3)"),e(),t(100,"div",13)(101,"table",28)(102,"thead")(103,"tr")(104,"th"),n(105,"Empresa"),e(),t(106,"th"),n(107,"Agua vertida (m3)"),e(),t(108,"th",15),n(109,"Acciones"),e()()(),t(110,"tbody",29),f(111,ne,7,4,"tr",17),t(112,"tr",18)(113,"td",19)(114,"strong"),n(115,"TOTAL"),e()(),t(116,"td",20)(117,"span",22),n(118),e()(),m(119,"td"),e()()()(),t(120,"button",23),g("click",function(){return a.agregarFilaVertimientos()}),n(121," \u2795 Agregar empresa "),e(),t(122,"input",30),g("click",function(){return a.submitFormEficienciaAgua()}),e()()()()),r&2&&(l(9),s("hidden",!a.eficienciaAgua),l(),s("formGroup",a.datoseficienciaagua),l(33),s("ngForOf",a.consumoAgua.controls),l(7),E(a.totalConsumoActual),l(3),E(a.totalConsumoAnterior),l(3),F("",x(57,10,a.calcularVariacionTotal(),"1.2-2"),"%"),l(26),s("ngForOf",a.accionesEficiencia.controls),l(7),E(x(90,13,a.totalAhorrosAgua,"1.2-2")),l(22),s("ngForOf",a.vertimientosAgua.controls),l(7),E(a.totalVertimientos))},dependencies:[B,V,G,k,w,J,M,R,P,U,q,$,Y,j,H]})}}return c})();export{ge as EficienciaAguaComponent};

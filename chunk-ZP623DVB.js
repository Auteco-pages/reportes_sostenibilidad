import{a as Z}from"./chunk-2PSR7T7J.js";import{a as k,b as m,c as L,d as $,e as q,f as M,g as P,i as z,j as H,k as Y,l as J,r as K,s as Q,t as W,u as X}from"./chunk-IAQZ57CQ.js";import{B as l,C as A,F as T,G as C,I as c,K as a,L as i,M as p,P as V,Q as S,R as E,S as o,T as h,U as x,W as B,X as b,Y as _,Z as v,c as F,da as G,ea as U,fa as O,ga as j,ha as w,na as R,s as y,w as D,x as I}from"./chunk-ACHKL7EZ.js";var N=(s,d)=>({"ng-invalid":s,"ng-valid":d});function te(s,d){if(s&1&&(a(0,"tr",30)(1,"td",31),o(2),i(),a(3,"td"),p(4,"input",32),i(),a(5,"td"),p(6,"input",32),i(),a(7,"td",33)(8,"span",34),o(9),_(10,"number"),i()()()),s&2){let e,t,n=d.$implicit,r=d.index,u=E();l(2),h(n),l(2),c("formControlName","consumo_actual_"+r)("ngClass",b(9,N,((e=u.datoseficienciaagua.get("consumo_agua"))==null||(e=e.get("consumo_actual_"+r))==null?null:e.invalid)&&((e=u.datoseficienciaagua.get("consumo_agua"))==null||(e=e.get("consumo_actual_"+r))==null?null:e.touched),((e=u.datoseficienciaagua.get("consumo_agua"))==null||(e=e.get("consumo_actual_"+r))==null?null:e.valid)&&((e=u.datoseficienciaagua.get("consumo_agua"))==null||(e=e.get("consumo_actual_"+r))==null?null:e.touched))),l(2),c("formControlName","consumo_anterior_"+r)("ngClass",b(12,N,((t=u.datoseficienciaagua.get("consumo_agua"))==null||(t=t.get("consumo_anterior_"+r))==null?null:t.invalid)&&((t=u.datoseficienciaagua.get("consumo_agua"))==null||(t=t.get("consumo_anterior_"+r))==null?null:t.touched),((t=u.datoseficienciaagua.get("consumo_agua"))==null||(t=t.get("consumo_anterior_"+r))==null?null:t.valid)&&((t=u.datoseficienciaagua.get("consumo_agua"))==null||(t=t.get("consumo_anterior_"+r))==null?null:t.touched))),l(3),x("",v(10,6,u.getVariacion(r),"1.2-2"),"%")}}function ie(s,d){if(s&1){let e=V();a(0,"button",42),S("click",function(){D(e);let n=E().index,r=E();return I(r.eliminarFilaEficiencia(n))}),o(1," \u274C "),i()}}function ae(s,d){if(s&1&&(a(0,"tr",35)(1,"td"),p(2,"input",36),i(),a(3,"td"),p(4,"textarea",37),i(),a(5,"td"),p(6,"textarea",38),i(),a(7,"td"),p(8,"input",39),i(),a(9,"td",40),C(10,ie,2,0,"button",41),i()()),s&2){let e=d.$implicit,t=d.index,n=E();c("formGroupName",t),l(2),c("ngClass",n.getFieldClass(e,"accion_implementada")),l(2),c("ngClass",n.getFieldClass(e,"descripcion_acciones")),l(2),c("ngClass",n.getFieldClass(e,"descripcion_resultados")),l(2),c("ngClass",n.getFieldClass(e,"ahorros_agua")),l(2),c("ngIf",n.accionesEficiencia.length>1)}}function ne(s,d){if(s&1&&(a(0,"tr",30)(1,"td",31),o(2),i(),a(3,"td"),p(4,"input",32),i()()),s&2){let e,t=d.$implicit,n=d.index,r=E();l(2),h(t),l(2),c("formControlName","agua_vertida_"+n)("ngClass",b(3,N,((e=r.datoseficienciaagua.get("vertimientos_agua"))==null||(e=e.get("agua_vertida_"+n))==null?null:e.invalid)&&((e=r.datoseficienciaagua.get("vertimientos_agua"))==null||(e=e.get("agua_vertida_"+n))==null?null:e.touched),((e=r.datoseficienciaagua.get("vertimientos_agua"))==null||(e=e.get("agua_vertida_"+n))==null?null:e.valid)&&((e=r.datoseficienciaagua.get("vertimientos_agua"))==null||(e=e.get("agua_vertida_"+n))==null?null:e.touched)))}}var pe=(()=>{class s extends W{constructor(e,t,n,r){super(),this.formBuilder=e,this.formService=t,this.formDataService=n,this.router=r,this.eficienciaAgua=!0,this.datoseficienciaagua=new q({}),this.filesToUpload=new Map,this.empresasFijas=["Auteco SAS","Auteco Mobility","Auteco BLUE"],this.totalConsumoActual=0,this.totalConsumoAnterior=0,this.variacionTotal=0,this.variaciones=[0,0,0],this.totalAhorrosAgua=0,this.totalVertimientos=0}ngOnInit(){this.datoseficienciaagua=this.formBuilder.group({consumo_agua:this.formBuilder.group({}),acciones_eficiencia:this.formBuilder.array([]),vertimientos_agua:this.formBuilder.group({})}),this.inicializarConsumoAgua(),this.inicializarVertimientos(),this.agregarFilaEficiencia(),this.datoseficienciaagua.valueChanges.subscribe(()=>{this.calcularTotales()}),this.calcularTotales()}inicializarConsumoAgua(){let e=this.datoseficienciaagua.get("consumo_agua");this.empresasFijas.forEach((t,n)=>{e.addControl(`consumo_actual_${n}`,this.formBuilder.control("",[m.required,m.min(0)])),e.addControl(`consumo_anterior_${n}`,this.formBuilder.control("",[m.required,m.min(0)]))})}getConsumoActual(e){let t=this.datoseficienciaagua.get("consumo_agua")?.get(`consumo_actual_${e}`);return Number(t?.value)||0}getConsumoAnterior(e){let t=this.datoseficienciaagua.get("consumo_agua")?.get(`consumo_anterior_${e}`);return Number(t?.value)||0}getVariacion(e){return this.variaciones[e]||0}get accionesEficiencia(){return this.datoseficienciaagua.get("acciones_eficiencia")}agregarFilaEficiencia(){let e=this.formBuilder.group({accion_implementada:["",m.required],descripcion_acciones:["",m.required],descripcion_resultados:["",m.required],ahorros_agua:["",[m.required,m.min(0)]]});e.valueChanges.subscribe(()=>this.calcularTotales()),this.accionesEficiencia.push(e)}eliminarFilaEficiencia(e){this.accionesEficiencia.length>1&&(this.accionesEficiencia.removeAt(e),this.calcularTotales())}inicializarVertimientos(){let e=this.datoseficienciaagua.get("vertimientos_agua");this.empresasFijas.forEach((t,n)=>{e.addControl(`agua_vertida_${n}`,this.formBuilder.control("",[m.required,m.min(0)]))})}getAguaVertida(e){let t=this.datoseficienciaagua.get("vertimientos_agua")?.get(`agua_vertida_${e}`);return Number(t?.value)||0}calcularTotales(){this.totalConsumoActual=0,this.totalConsumoAnterior=0,this.empresasFijas.forEach((e,t)=>{let n=this.getConsumoActual(t),r=this.getConsumoAnterior(t);this.totalConsumoActual+=n,this.totalConsumoAnterior+=r,r>0?this.variaciones[t]=(n-r)/r*100:this.variaciones[t]=0}),this.totalConsumoAnterior>0?this.variacionTotal=(this.totalConsumoActual-this.totalConsumoAnterior)/this.totalConsumoAnterior*100:this.variacionTotal=0,this.totalAhorrosAgua=0,this.accionesEficiencia.controls.forEach(e=>{this.totalAhorrosAgua+=Number(e.get("ahorros_agua")?.value)||0}),this.totalVertimientos=0,this.empresasFijas.forEach((e,t)=>{this.totalVertimientos+=this.getAguaVertida(t)})}getNumericValue(e){let t=this.datoseficienciaagua.get(e)?.value;return Number(t)||0}onFileSelected(e,t){let n=e.target.files[0];n&&(this.filesToUpload.set(t,n),console.log(`Archivo seleccionado: ${n.name} para ${t}`))}convertFileToBase64(e){return F(this,null,function*(){return new Promise((t,n)=>{let r=new FileReader;r.onload=()=>t(r.result),r.onerror=n,r.readAsDataURL(e)})})}submitFormEficienciaAgua(){return F(this,null,function*(){this.markFormGroupTouched(this.datoseficienciaagua),this.datoseficienciaagua.valid?(console.log("\u2705 Formulario Eficiencia en el Uso del Agua v\xE1lido"),yield this.sendAttachment()):(console.log("\u274C Formulario Eficiencia en el Uso del Agua inv\xE1lido"),this.scrollToFirstError(),alert("Por favor, complete todos los campos obligatorios"))})}sendAttachment(){return F(this,null,function*(){let e=[];for(let[g,f]of this.filesToUpload.entries()){console.log("\u{1F4CE} Procesando archivo:",g);let ee=yield this.convertFileToBase64(f);e.push({fileName:g,fileData:ee})}let t=this.formDataService.getDatosIniciales(),n=this.empresasFijas.map((g,f)=>({empresa:g,consumo_actual:this.getConsumoActual(f),consumo_anterior:this.getConsumoAnterior(f),variacion_porcentual:this.getVariacion(f)})),r=this.empresasFijas.map((g,f)=>({empresa:g,agua_vertida:this.getAguaVertida(f)})),u={consumo_agua_grupo:{datos:n,totales:{total_consumo_actual:this.totalConsumoActual,total_consumo_anterior:this.totalConsumoAnterior,variacion_total:this.variacionTotal}},acciones_eficiencia_agua:{datos:this.datoseficienciaagua.value.acciones_eficiencia,totales:{total_ahorros_agua:this.totalAhorrosAgua}},vertimientos_agua:{datos:r,totales:{total_vertimientos:this.totalVertimientos}},metadata:{fecha_reporte:new Date().toISOString(),formulario_completo:this.datoseficienciaagua.valid}};console.log("\u{1F4CA} Datos a enviar:",u),this.formService.upload(e,t,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,u).subscribe({next:g=>{console.log("\u2705 Datos enviados exitosamente:",g),this.formDataService.clearDatosIniciales(),this.router.navigate(["/confirmacion"])},error:g=>{console.error("\u274C Error al enviar:",g),alert("Hubo un error al enviar los datos. Por favor, intente nuevamente.")}})})}static{this.\u0275fac=function(t){return new(t||s)(A(K),A(Z),A(X),A(R))}}static{this.\u0275cmp=y({type:s,selectors:[["app-eficiencia-agua"]],standalone:!0,features:[T,B],decls:116,vars:25,consts:[[1,"form-header"],[1,"header-content"],[1,"header-text"],["src","assets/auteco-logo.png","alt","Logo Empresa",1,"logo-empresa"],["id","msform"],[1,"border-green",3,"hidden"],[3,"ngSubmit","formGroup"],[1,"section-header"],[1,"icon"],[1,"fs-subtitle"],[1,"info-box"],[1,"subsection-header"],[1,"table-subtitle"],[1,"table-container"],["formGroupName","consumo_agua",1,"gri-table","agua-table-consumo"],["class","fila-empresa",4,"ngFor","ngForOf"],[1,"totales-row"],[1,"total-label"],[1,"total-cell"],[1,"resultado-total"],[1,"resultado-total-final"],[1,"subsection-header",2,"margin-top","50px"],[1,"gri-table","agua-table-acciones"],[1,"acciones-col"],["formArrayName","acciones_eficiencia"],[3,"formGroupName",4,"ngFor","ngForOf"],["colspan","3",1,"total-label"],["type","button",1,"btn-agregar-fila",3,"click"],["formGroupName","vertimientos_agua",1,"gri-table","agua-table-vertimientos"],["type","button","value","GUARDAR Y ENVIAR",1,"action-button","success",3,"click"],[1,"fila-empresa"],[1,"dato-label"],["type","number","step","0.01","placeholder","0",3,"formControlName","ngClass"],[1,"valor-calculado"],[1,"resultado"],[3,"formGroupName"],["type","text","formControlName","accion_implementada","placeholder","Acci\xF3n implementada",3,"ngClass"],["formControlName","descripcion_acciones","placeholder","Descripci\xF3n de las acciones...","rows","3",3,"ngClass"],["formControlName","descripcion_resultados","placeholder","Descripci\xF3n de los resultados...","rows","3",3,"ngClass"],["type","number","formControlName","ahorros_agua","step","0.01","placeholder","0.00",3,"ngClass"],[1,"acciones-cell"],["type","button","class","btn-eliminar","title","Eliminar fila",3,"click",4,"ngIf"],["type","button","title","Eliminar fila",1,"btn-eliminar",3,"click"]],template:function(t,n){t&1&&(a(0,"div",0)(1,"div",1)(2,"div",2)(3,"h1"),p(4,"img",3),o(5,"Plataforma de Gesti\xF3n - Informe de Sostenibilidad"),i(),a(6,"p"),o(7,"Sistema de recolecci\xF3n de datos para reportes GRI"),i()()()(),a(8,"form",4)(9,"fieldset",5)(10,"form",6),S("ngSubmit",function(){return n.submitFormEficienciaAgua()}),a(11,"div",7)(12,"span",8),o(13,"\u{1F4A7}"),i(),a(14,"h2"),o(15,"Eficiencia en el Uso del Agua"),i()(),a(16,"p",9),o(17," Complete la informaci\xF3n sobre consumo de agua, acciones de eficiencia y vertimientos "),i(),a(18,"div",10)(19,"strong"),o(20,"\u2139\uFE0F INSTRUCCIONES:"),i(),o(21," Complete todas las secciones sobre consumo y gesti\xF3n del agua. "),i(),a(22,"div",11)(23,"span",8),o(24,"\u{1F4A7}"),i(),o(25," EFICIENCIA EN EL USO DEL AGUA - Contenido GRI: 303-5 "),i(),a(26,"h3",12),o(27,"Consumo de agua y variaci\xF3n respecto al a\xF1o anterior"),i(),a(28,"div",13)(29,"table",14)(30,"thead")(31,"tr")(32,"th"),o(33,"Empresa"),i(),a(34,"th"),o(35,"Consumo de agua a\xF1o actual (m3)"),i(),a(36,"th"),o(37,"Consumo de agua a\xF1o anterior (m3)"),i(),a(38,"th"),o(39,"Variaci\xF3n (%)"),i()()(),a(40,"tbody"),C(41,te,11,15,"tr",15),a(42,"tr",16)(43,"td",17)(44,"strong"),o(45,"TOTAL"),i()(),a(46,"td",18)(47,"span",19),o(48),_(49,"number"),i()(),a(50,"td",18)(51,"span",19),o(52),_(53,"number"),i()(),a(54,"td",18)(55,"span",20),o(56),_(57,"number"),i()()()()()(),a(58,"div",21)(59,"span",8),o(60,"\u{1F30A}"),i(),o(61," EFICIENCIA EN EL USO DEL AGUA - Contenido GRI: N/A "),i(),a(62,"h3",12),o(63,"Acciones implementadas de eficiencia en el uso del agua"),i(),a(64,"div",13)(65,"table",22)(66,"thead")(67,"tr")(68,"th"),o(69,"Acci\xF3n implementada"),i(),a(70,"th"),o(71,"Descripci\xF3n de las acciones y su objetivo"),i(),a(72,"th"),o(73,"Descripci\xF3n de los resultados obtenidos"),i(),a(74,"th"),o(75,"Ahorros de agua generados (m3)"),i(),a(76,"th",23),o(77,"Acciones"),i()()(),a(78,"tbody",24),C(79,ae,11,6,"tr",25),a(80,"tr",16)(81,"td",26)(82,"strong"),o(83,"TOTAL"),i()(),a(84,"td",18)(85,"span",20),o(86),_(87,"number"),i()(),p(88,"td"),i()()()(),a(89,"button",27),S("click",function(){return n.agregarFilaEficiencia()}),o(90," \u2795 Agregar acci\xF3n de eficiencia "),i(),a(91,"div",21)(92,"span",8),o(93,"\u{1F6B0}"),i(),o(94," GESTI\xD3N DE VERTIMIENTOS DE AGUA - Contenido GRI: 303-4 "),i(),a(95,"h3",12),o(96,"Vertimientos de agua (m3)"),i(),a(97,"div",13)(98,"table",28)(99,"thead")(100,"tr")(101,"th"),o(102,"Empresa"),i(),a(103,"th"),o(104,"Agua vertida (m3)"),i()()(),a(105,"tbody"),C(106,ne,5,6,"tr",15),a(107,"tr",16)(108,"td",17)(109,"strong"),o(110,"TOTAL"),i()(),a(111,"td",18)(112,"span",20),o(113),_(114,"number"),i()()()()()(),a(115,"input",29),S("click",function(){return n.submitFormEficienciaAgua()}),i()()()()),t&2&&(l(9),c("hidden",!n.eficienciaAgua),l(),c("formGroup",n.datoseficienciaagua),l(31),c("ngForOf",n.empresasFijas),l(7),h(v(49,10,n.totalConsumoActual,"1.0-0")),l(4),h(v(53,13,n.totalConsumoAnterior,"1.0-0")),l(4),x("",v(57,16,n.variacionTotal,"1.2-2"),"%"),l(23),c("ngForOf",n.accionesEficiencia.controls),l(7),h(v(87,19,n.totalAhorrosAgua,"1.2-2")),l(20),c("ngForOf",n.empresasFijas),l(7),h(v(114,22,n.totalVertimientos,"1.0-0")))},dependencies:[w,G,U,O,j,Q,M,k,P,L,$,z,J,H,Y]})}}return s})();export{pe as EficienciaAguaComponent};
